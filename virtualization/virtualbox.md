
#### Virtual Box

I still love xen for workstation or server environments, but I have begun to question the use of other type-2 hypervisors for some workstation needs.

Recently iommu support has begun to spring up under other platforms, including kvm and virtualbox.  However, due to the sheer popularity of these platforms and the common theme of xen being deprecated (which is probably true for desktop users) the advent of iommu enhancements on the server platform is likely to grow stagnent.

In my opinion VirtualBox has recently taken the stage by storm.  It now supports EFI BIOS and PCI Passthrough, and it is cross platform compatible.  Further, its support for linux guest extensions is far and away above any of the competing systems.

**Parallels and VMWare suck at supporting linux guests.**  _Parallels offers EFI without any efivars, so it is a meaningless gesture, and probably only acceptable for Windows VMs._

Any modern linux kernel will not work with parallels or vmware `tools`.  They are always way out of touch with any bleeding edge distros.

Part of the point of virtualization to me is being able to test features before loading them onto a real system, and if the systems that provide these new features don't work because they are "too new", then that eliminates one huge benefit for me.

I recently experienced an install of arch and debian in VirtualBox that was **mostly** phenominal, and have since dropped parallels as my OSX preferred virtualization package.


##### OS X

VirtualBox now supports OSX **guests**.

This gives it a very distinct advantage over almost ALL of its competition, especially being a cross platform FREE service.

Xen has an EFI bootloader, though documentation of OS X installation is scarce, and the same holds true of kvm and xen.

Parallels has support, if you're running a licensed server copy of OSX, which is utter bullshit.  OSX, like every other OS, should be virtualization compatible without "stupid" limitations, however until the demand grows popular enough nobody will make it happen.


##### VGA Passthrough

VirtualBox now has limited support for IOMMU, and graphics passthrough:

- [Ubuntu Laptop GPU Passthrough](http://askubuntu.com/questions/202926/how-to-use-nvidia-geforce-m310-on-ubuntu-12-10-running-as-guest-in-virtualbox)

If this works even with an additional 10% loss in performance, it may still be a better place than where I am with xen today provided it does not experience the same performance degredation and reboot requirements.


##### VBox Networking is still Terrible

Unfortunately I cannot say VirtualBox is without flaws.  Configuring networks on VirtualBox is way more complex than it should ever need to be.

It defaults to NAT networks, which somehow have a "block all ports" firewall built into the virtual NAT, which prevents you from accessing the machine or sharing the machine externally.

You can use host-only virtual networks to access, and a bridge network to provide internet and external access.  However, that is two networks to accomplish what should be acheivable with only one.  There is no port forwarding options on the host-only, or is there internet access.

The bridged network option works great, unless you need the IP Address to be reliable, such as when testing web development using the hosts file on the host machine.


##### EFI Booting

VirtualBox does have EFI support, but it's currently in testing.  That said, it works spectacularly well so far.

Apparently their EFI menu uses "Volatile" NVRam (yes, that is "volatile non-volatile ram").  This means that the first installation will add your boot option, and it will work with reboots up until you shutdown.  When you shutdown it wipes its memory.

Fortunately there are two ways to work around this, both are equally decent, and you can add both as a fallback for emergencies.

First, the EFI shell says it will run `startup.nsh`, which is an `nsh` shell file for EFI.  This file is inside the EFI partition, **not** the boot partition.  So, if you have a `/boot/efi` mounted fat32, then what you want to do is add `/boot/efi/start.nsh` with:

    fs0:\EFI\grub\grubx64.efi

Where the above is the parth from the fat32 partition to the efi file generated by grub.

Now, this option does work, but... it adds a 5 second overhead to boot times because it will wait for commands before running any startup.nsh files it locates.

Which brings us to the second, slightly superior option.  This method can be done in addition to the above method, and will process first, so as a "just-in-case" situation it is not bad.

From the mounted directory, we want to create `/boot/efi/EFI/boot/` and copy the `grubx64.efi` to `bootx64.efi` inside the boot folder.  From the fat32 drive the path would be `/EFI/boot/bootx64.efi`.  The system will apparently pickup on that name first, and it will execute it without waiting or looking at the startup.nsh script.


##### Renaming Disks

VirtualBox for whatever reason does not condone renaming disks.  One reason is probably tied to the snapshot names, so if your box has snapshots this may or may not work well.

There are two solutions.  The first (and more practical) is to remove the disk from the VM, then use `VBoxManage` to closemedium so it is not stored in VirtualBox's data system.  Then you can rename the file and re-add it.

Alternatively you may find a need to clone it and then swap the old for the new.  From command line you can create a clone, and then swap it out:

    VBoxManage clonehd /path/to/old.vdi /path/to/new.vdi --format VDI --remember

_Note that deleting the old disks may also need you to run the VBoxManage closemedia command as well to remove orphaned drives._

_Also note that snapshot names may be a problem to change, and a changed drive name may also create trouble._


##### Compressing Disks

You cannot compress a snapshot, but you can compress the main disk of any system.

The command to do so:

    VBoxManage modifyhd --compact /path/to/disk

_Alternaitvely you can get the UUID of the disk and use that in place of the path._


##### Guest Additions

For video, shared folders, and a few other enhancements you can install VirtualBox Guest Additions onto any guest machine.

While you can do so using the CDRom they provide, an alternative is to use packages provided by your distribution.

**arch**

As a prime example, arch has a really updated kernel that the VBox CD may not be coded for, so you would probably rather run this command:

    pacman -S virtualbox-guest-utils

Then create `/etc/modules-load.d/virtualbox.conf` with:

    vboxguest
    vboxsf
    vboxvideo

You may need to rebuild the initramfs (`mkinitcpio -p linux`).  Also, anytime the kernel (linux) package is updated you will probably want to remove and reinstall the virtualbox guest additions and rebuild the initramfs (mkinitcpio).

**debian**

You can simply use the `aptitude` command to install the `` utilities.  It should handle everything else.  Or you can try the mounted image supplied with the latest virtualbox, which may or may not be fully configured for your distro.

_Guest additions depends on `build-essential` and `module-assistant` packages._
