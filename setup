#!/bin/bash


##
# get script info
##

if [ $(uname) = "Darwin" ]
then
    SELF=$(cd $(dirname "$0") && pwd -P)/$(basename "$0")
else
    SELF=$(readlink -f "$0")
fi
SELF_PATH=$(dirname "$SELF")


##
# validate running as root user
##
if [ $(id -u) -ne 0 ]
then
    echo "this script must be run with privileges (eg. as root or with sudo)"
    exit 1
fi


##
# define supplemental functions
##

dot_files_repo()
{

    # was a dot-files repo supplied?
    if [ -n "$DOT_FILES_REPO" ]
    then

        # attempt to clone outside of the system-setup repo
        cd /tmp
        rm -rf "/tmp/dot-files"
        git clone "$DOT_FILES_REPO" "dot-files"

        ##
        # expected format is to have an install script
        # if available a github username, github password
        # and system username will be supplied optionally
        ##
        cd "dot-files"
        if [ -n "$GITHUB_USERNAME" ]
        then
            if [ -n "$GITHUB_PASSWORD" ]
            then
                if [ -n "$PASSWORD" ]
                then
                    ./install "$GITHUB_USERNAME" "$GITHUB_PASSWORD" "$PASSWORD"
                else
                    ./install "$GITHUB_USERNAME" "$GITHUB_PASSWORD"
                fi
            else
                ./install "$GITHUB_USERNAME"
            fi
        else
            ./install
        fi

        # cleanup after itself & return to the original path
        rm -rf "/tmp/dot-files"
        cd "$SELF_PATH"
    fi
}


##
# define primary functions
##

template()
{

    # handle package installations
    aptitude install -r -y netselect-apt
    netselect-apt -s -n
    aptitude clean
    aptitude update
    dpkg -r vim-common vim-tiny
    aptitude reinstall -r -y firmware-linux firmware-linux-free firmware-linux-nonfree usbutils uuid-runtime debconf-utils cpufrequtils bzip2 lzop p7zip-full zip unzip unrar xz-utils unace rzip unalz zoo arj netselect-apt ssh curl ntp rsync whois vim git git-flow mercurial debhelper libncurses5-dev kernel-package build-essential fakeroot e2fsprogs parted sshfs fuse-utils gvfs-fuse exfat-fuse exfat-utils fusesmb os-prober sudo bash-completion command-not-found tmux screen bc less keychain pastebinit anacron miscfiles monit markdown
    aptitude install -r -y firmware-linux firmware-linux-free firmware-linux-nonfree usbutils uuid-runtime debconf-utils cpufrequtils bzip2 lzop p7zip-full zip unzip unrar xz-utils unace rzip unalz zoo arj netselect-apt ssh curl ntp rsync whois vim git git-flow mercurial debhelper libncurses5-dev kernel-package build-essential fakeroot e2fsprogs parted sshfs fuse-utils gvfs-fuse exfat-fuse exfat-utils fusesmb os-prober sudo bash-completion command-not-found tmux screen bc less keychain pastebinit anacron miscfiles monit markdown
    update-command-not-found

    # copy template files
    shopt -s dotglob
    cp -r "${SELF_PATH}/data/template/"* /
    shopt -u dotglob

    ##
    # update specific copied files
    ##

    # cronjobs
    chmod +x /etc/cron.monthly/netselect-apt
    chmod +x /etc/cron.weekly/aptitude
    chmod +x /etc/cron.weekly/e4defrag
    chmod +x /etc/cron.weekly/fstrim

    # monit
    cd /etc/monit/conf.d
    ln -s ../monitrc.d/ssh ssh
    ln -s ../monitrc.d/system system
    ln -s ../monitrc.d/web web
    service monit restart
    cd "$SELF_PATH"

    ##
    # configure services
    ##

    # lvm and default umask
    sed -i 's/issue_discards = 0/issue_discards = 1/' /etc/lvm/lvm.conf
    sed -i 's/UMASK\s*022/UMASK        002/' /etc/login.defs
    echo "session optional pam_umask.so umask=002" >> /etc/pam.d/common-session

    # ssh, iptables port, and auto-boot
    sed -i "s/Port 22/Port ${SSH_PORT}/" /etc/ssh/sshd_config
    sed -i "s/ssh/${SSH_PORT}/" /etc/firewall.conf
    chmod +x /etc/network/if-up.d/iptables

    # reload ssh & setup iptables
    service ssh restart
    iptables-restore < /etc/firewall.conf

    # add jp locale
    echo "ja_JP.UTF-8 UTF-8" >> /etc/locale.gen
    locale-gen

    # create new user
    if [ -n "$USERNAME" ] && [ -n "$PASSWORD" ]
    then
        useradd -m -s /bin/bash -p $(mkpasswd -m md5 "$PASSWORD") "$USERNAME"
        usermod -aG sudo username

        # alternative two-line /w pipe create-new-user
        # useradd -m -s /bin/bash "$USERNAME"
        # echo "$PASSWORD" | passwd username --stdin
    fi

    # install dot files
    dot_files_repo

}

osx()
{
    echo "running osx setup"
}

gui()
{
    echo "installing gui tools"
}

gnome()
{
    echo "installing gnome environment"
}

openbox()
{
    echo "installing openbox environment"
}

xen()
{
    echo "installing xen environment"
}

web()
{
    echo "installing web environment"

    # execute template
    template

    # install more services


    # domain config
    if [ -n "$HOSTNAME" ]
    then
        echo "$HOSTNAME" > /etc/hostname
        hostname -F /etc/hostname
    fi
    if [ -n "$USERNAME" ]
    then
        # 127.0.1.1 hostname.domain.dev hostname
        sed
        echo "${USERNAME}.local"
    fi
}

comm()
{
    echo "installing communications environment"
}

raspbian()
{
    echo "installing raspbian environment"
}


##
# parse arguments & load config
##

# track executed processes
INSTALLED=()

# optional hostname
if [ -n "$1" ]
then
    HOSTNAME="$1"
fi

# load config
. "$SELF_PATH/config"


##
# execute setup according to arguments
##

echo -ne "Installation will commence in 10 seconds, \nplease ctrl+c to cancel before then, \nor wait until it finishes..."
sleep 10

if [ -n "$0" ] && [ $(type -t $0) = "function" ]
then
    $0
elif [ $(uname) = "Darwin" ]
then
    osx
elif which arch &> /dev/null && [[ $(arch | tr '[:upper:]' '[:lower:]') == *arm* ]]
then
    raspbian
else
    template
fi
